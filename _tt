#compdef tt

_tt() {
    local -a commands shortcuts
    
    commands=(
        'start:Start a new timer'
        'stop:Stop the current timer'
        'note:Add a note to running timer'
        'report:View daily summary'
        'copy:Copy report to clipboard'
        'add:Add customer/project'
        'shortcut:Manage shortcuts'
        'reset:Clear daily data'
        'help:Show help'
    )
    
    # Read shortcuts dynamically from config
    local config_file="$HOME/.tt_config.json"
    if [[ -f "$config_file" ]]; then
        # Use the built-in --complete flag
        local shortcut_lines
        shortcut_lines=(${(f)"$(tt shortcut --complete 2>/dev/null)"})
        
        # Build descriptions from full config
        for shortcut in $shortcut_lines; do
            local name="${shortcut#@}"
            local desc=$(python3 -c "
import json
try:
    with open('$config_file') as f:
        data = json.load(f)
        s = data.get('shortcuts', {}).get('$name', {})
        print(f\"{s.get('customer', '')} - {s.get('project', '')}\")
except: pass
" 2>/dev/null)
            shortcuts+=("$shortcut:$desc")
        done
    fi
    
    _arguments -C \
        '1: :->command' \
        '*:: :->args'
    
    case $state in
        command)
            _describe 'command' commands
            ;;
        args)
            case $words[1] in
                start)
                    # Offer shortcuts when typing @ or after -s
                    if [[ $words[CURRENT-1] == "-s" ]] || [[ $PREFIX == @* ]]; then
                        _describe 'shortcut' shortcuts
                    fi
                    ;;
                shortcut|shortcuts)
                    if [[ $CURRENT -eq 2 ]]; then
                        local -a shortcut_commands
                        shortcut_commands=(
                            'list:List all shortcuts'
                            'add:Create new shortcut'
                            'delete:Remove shortcut'
                        )
                        _describe 'shortcut command' shortcut_commands
                    fi
                    ;;
            esac
            ;;
    esac
}

_tt "$@"

